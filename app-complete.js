/* MindStep v5.0 - Production Ready */
const APP_VERSION='5.0',WEATHER_API_KEY='';let currentDate=new Date(),routines=[],walkData={isActive:!1,isPaused:!1,startTime:null,elapsedTime:0,pausedTime:0,distance:0,positions:[],watchId:null},timerInterval=null,recognition=null,isRecording=!1,transcriptText='';const BADGES=[{id:'first_walk',name:'Primo Passo',icon:'üö∂',req:1,type:'walks',desc:'Completa la tua prima camminata'},{id:'week_warrior',name:'Guerriero',icon:'‚öîÔ∏è',req:7,type:'streak',desc:'7 giorni consecutivi'},{id:'distance_10',name:'10km',icon:'üéØ',req:10,type:'distance',desc:'10km totali'},{id:'routine_50',name:'A Met√†',icon:'üìä',req:1,type:'special',desc:'50% routine completate'},{id:'routine_100',name:'Perfetto',icon:'‚ú®',req:1,type:'special',desc:'100% routine completate'},{id:'time_20',name:'20 minuti',icon:'‚è±Ô∏è',req:20,type:'walk_time',desc:'20 minuti di camminata'},{id:'time_40',name:'40 minuti',icon:'‚åõ',req:40,type:'walk_time',desc:'40 minuti di camminata'},{id:'first_note',name:'Primo Pensiero',icon:'üí≠',req:1,type:'brainstorm',desc:'Primo brainstorming salvato'}];const QUOTES=[{text:"Il successo √® la somma di piccoli sforzi ripetuti.",author:"Robert Collier"},{text:"Non conta quante volte cadi, ma quante volte ti rialzi.",author:"Vince Lombardi"},{text:"Il corpo raggiunge ci√≤ che la mente crede.",author:"Napoleon Hill"},{text:"L'unico modo per fare un ottimo lavoro √® amare quello che fai.",author:"Steve Jobs"},{text:"La motivazione ti fa iniziare. L'abitudine ti fa continuare.",author:"Jim Ryun"}];function init(){checkVersion();const u=localStorage.getItem('mindstep_user');u?(routines=JSON.parse(localStorage.getItem('mindstep_routines')||'[]'),showScreen('screen-main'),loadMainScreen()):showScreen('screen-welcome');requestPermissions();loadWeather();registerSW()}function checkVersion(){localStorage.setItem('mindstep_version',APP_VERSION)}function registerSW(){'serviceWorker'in navigator&&navigator.serviceWorker.register('./service-worker.js').catch(e=>console.warn('SW:',e))}function requestPermissions(){'Notification'in window&&Notification.permission==='default'&&Notification.requestPermission()}function showScreen(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'))}function showTab(tab){const map={home:'screen-main',calendar:'screen-calendar',stats:'screen-stats',achievements:'screen-achievements',settings:'screen-settings'};showScreen(map[tab]);document.getElementById('nav'+tab.charAt(0).toUpperCase()+tab.slice(1)).classList.add('active')}function saveProfile(){const n=document.getElementById('userName').value.trim();if(!n){alert('Inserisci il tuo nome');return}localStorage.setItem('mindstep_user',JSON.stringify({name:n,age:document.getElementById('userAge').value,gender:document.getElementById('userGender').value,createdAt:new Date().toISOString()}));showScreen('screen-routines');setTimeout(()=>addRoutineSetup(),100)}function addRoutineSetup(){if(routines.length>=10){alert('Massimo 10 routine');return}const item=document.createElement('div');item.style.cssText='display:flex;gap:12px;margin-bottom:10px;align-items:center';item.innerHTML=`<input type="text" placeholder="Es: Meditazione, Sport..." data-idx="${routines.length}" style="flex:1;padding:12px;border:1px solid var(--border);border-radius:var(--radius-md);font:inherit"><button onclick="this.parentElement.remove();routines.splice(${routines.length},1);document.getElementById('routineCount').textContent=routines.length" style="width:40px;height:40px;border-radius:50%;border:none;background:#e97676;color:#fff;cursor:pointer;font-size:18px">√ó</button>`;document.getElementById('routineList').appendChild(item);routines.push('');document.getElementById('routineCount').textContent=routines.length}function saveRoutines(){routines=Array.from(document.querySelectorAll('#routineList input')).map(i=>i.value.trim()).filter(v=>v);if(!routines.length){alert('Aggiungi almeno una routine');return}localStorage.setItem('mindstep_routines',JSON.stringify(routines));showScreen('screen-main');loadMainScreen()}function loadMainScreen(){const u=JSON.parse(localStorage.getItem('mindstep_user'));document.getElementById('appTitle').textContent=`Ciao, ${u.name}!`;updateQuote();loadRoutineChecklist();updateStreak();updateWeeklyAnalytics();updateBadges();loadQuotable()}async function loadQuotable(){try{const r=await fetch('https://api.quotable.io/random?tags=inspirational');if(r.ok){const d=await r.json();document.getElementById('quoteText').textContent=`"${d.content}"`;document.getElementById('quoteAuthor').textContent=d.author}}catch(e){console.warn('Quote:',e)}}function updateQuote(){const q=QUOTES[Math.floor(Math.random()*QUOTES.length)];document.getElementById('quoteText').textContent=`"${q.text}"`;document.getElementById('quoteAuthor').textContent=q.author}async function loadWeather(){if(!navigator.geolocation)return;try{const pos=await new Promise((res,rej)=>navigator.geolocation.getCurrentPosition(res,rej,{timeout:5000}));const{latitude:lat,longitude:lon}=pos.coords;const url=`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=DEMO_KEY&units=metric&lang=it`;const r=await fetch(url);if(!r.ok)return;const d=await r.json();const icons={'Clear':'‚òÄÔ∏è','Clouds':'‚òÅÔ∏è','Rain':'üåßÔ∏è','Snow':'‚ùÑÔ∏è','Drizzle':'üå¶Ô∏è'};document.getElementById('weatherIcon').textContent=icons[d.weather[0].main]||'‚õÖ';document.getElementById('weatherTemp').textContent=Math.round(d.main.temp)+'¬∞'}catch(e){console.warn('Weather:',e)}}function loadRoutineChecklist(){const list=document.getElementById('routineChecklist');list.innerHTML='';if(!routines.length){list.innerHTML='<p style="text-align:center;opacity:.5;padding:20px;font-size:14px">Vai in Altro ‚Üí Modifica Routine</p>';return}const key=currentDate.toISOString().split('T')[0],data=getDayData(key);routines.forEach((r,i)=>{const item=document.createElement('div');item.className='routine-item'+(data.routines?.[i]?' completed':'');item.innerHTML=`<input type="checkbox" class="routine-checkbox" id="r${i}" ${data.routines?.[i]?'checked':''} onchange="saveRoutine(${i})"><label class="routine-label" for="r${i}">${r}</label>`;list.appendChild(item)});updateProgress()}function saveRoutine(i){const key=currentDate.toISOString().split('T')[0],cb=document.getElementById(`r${i}`);let d=getDayData(key);d.routines=d.routines||{};d.routines[i]=cb.checked;saveDayData(key,d);cb.parentElement.classList.toggle('completed',cb.checked);updateProgress();updateWeeklyAnalytics();checkMilestones('routine')}function updateProgress(){const cbs=document.querySelectorAll('.routine-checkbox'),total=cbs.length,done=Array.from(cbs).filter(c=>c.checked).length,pct=total>0?Math.round((done/total)*100):0;document.getElementById('routineSummary').textContent=`${done}/${total}`;document.getElementById('progressBar').style.width=pct+'%';document.getElementById('progressPct').textContent=pct+'%';if(pct===50)checkMilestones('routine_50');if(pct===100)checkMilestones('routine_100')}function toggleWalk(){walkData.isActive?(walkData.isPaused?resumeWalk():pauseWalk()):startWalk()}function startWalk(){walkData.isActive=!0;walkData.isPaused=!1;walkData.startTime=Date.now();walkData.elapsedTime=0;walkData.positions=[];walkData.distance=0;updateWalkBtn();timerInterval=setInterval(updateTimer,1000);if(navigator.geolocation){walkData.watchId=navigator.geolocation.watchPosition(pos=>{const n={lat:pos.coords.latitude,lng:pos.coords.longitude};if(walkData.positions.length>0){const l=walkData.positions[walkData.positions.length-1],d=calcDistance(l.lat,l.lng,n.lat,n.lng);if(d>0.005){walkData.distance+=d;document.getElementById('distanceDisplay').textContent=walkData.distance.toFixed(2)}}walkData.positions.push(n)},console.warn,{enableHighAccuracy:!0,maximumAge:1000})}}function pauseWalk(){walkData.isPaused=!0;walkData.pausedTime=Date.now();clearInterval(timerInterval);walkData.watchId&&(navigator.geolocation.clearWatch(walkData.watchId),walkData.watchId=null);updateWalkBtn()}function resumeWalk(){walkData.isPaused=!1;walkData.startTime+=Date.now()-walkData.pausedTime;updateWalkBtn();timerInterval=setInterval(updateTimer,1000);navigator.geolocation&&(walkData.watchId=navigator.geolocation.watchPosition(pos=>{const n={lat:pos.coords.latitude,lng:pos.coords.longitude};if(walkData.positions.length>0){const l=walkData.positions[walkData.positions.length-1],d=calcDistance(l.lat,l.lng,n.lat,n.lng);if(d>0.005){walkData.distance+=d;document.getElementById('distanceDisplay').textContent=walkData.distance.toFixed(2)}}walkData.positions.push(n)},console.warn,{enableHighAccuracy:!0}))}function updateWalkBtn(){const btn=document.getElementById('walkBtn'),icon=document.getElementById('walkBtnIcon'),text=document.getElementById('walkBtnText');if(!walkData.isActive){btn.className='btn btn-primary';icon.innerHTML='<path d="M5 3l14 9-14 9V3z"/>';text.textContent='Inizia'}else if(walkData.isPaused){btn.className='btn btn-primary';icon.innerHTML='<path d="M5 3l14 9-14 9V3z"/>';text.textContent='Riprendi'}else{btn.className='btn';btn.style.background='#e97676';icon.innerHTML='<rect x="6" y="6" width="4" height="12"/><rect x="14" y="6" width="4" height="12"/>';text.textContent='Pausa'}}function updateTimer(){walkData.elapsedTime=Date.now()-walkData.startTime;const t=Math.floor(walkData.elapsedTime/1000),h=Math.floor(t/3600),m=Math.floor((t%3600)/60),s=t%60;document.getElementById('timerDisplay').textContent=`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;const prog=document.getElementById('timerProgress'),circ=578,elapsed_min=walkData.elapsedTime/60000,offset=circ-(circ*(Math.min(elapsed_min/60,1)));prog.style.strokeDashoffset=offset;if(walkData.distance>0&&walkData.elapsedTime>0){const hrs=walkData.elapsedTime/3600000;document.getElementById('speedDisplay').textContent=(walkData.distance/hrs).toFixed(1)}document.getElementById('caloriesDisplay').textContent=Math.round(walkData.distance*65);if(elapsed_min>=20)checkMilestones('time_20');if(elapsed_min>=40)checkMilestones('time_40')}function calcDistance(lat1,lon1,lat2,lon2){const R=6371,dLat=(lat2-lat1)*Math.PI/180,dLon=(lon2-lon1)*Math.PI/180,a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))}function toggleRecording(){isRecording?stopRecording():startRecording()}function startRecording(){if(!('webkitSpeechRecognition'in window)){alert('Trascrizione non supportata. Scrivi manualmente.');return}recognition=new webkitSpeechRecognition();recognition.continuous=!0;recognition.interimResults=!0;recognition.lang='it-IT';recognition.onstart=()=>{isRecording=!0;document.getElementById('recordBtn').className='btn';document.getElementById('recordBtn').style.background='#e97676';document.getElementById('recordBtnText').textContent='‚èπÔ∏è Stop';document.getElementById('recordingIndicator').classList.remove('hidden')};recognition.onresult=e=>{let interim='';for(let i=e.resultIndex;i<e.results.length;i++){if(e.results[i].isFinal)transcriptText+=e.results[i][0].transcript+' ';else interim+=e.results[i][0].transcript}document.getElementById('brainstormNotes').value=transcriptText+interim};recognition.onerror=()=>stopRecording();recognition.start()}function stopRecording(){if(recognition){recognition.stop();recognition=null}isRecording=!1;document.getElementById('recordBtn').className='btn btn-secondary';document.getElementById('recordBtnText').textContent='üéôÔ∏è Registra';document.getElementById('recordingIndicator').classList.add('hidden');saveBrainstorm()}function saveBrainstorm(){const notes=document.getElementById('brainstormNotes').value,key=currentDate.toISOString().split('T')[0];let d=getDayData(key);d.brainstorm=notes;saveDayData(key,d);if(notes&&!d.firstBrainstorm){d.firstBrainstorm=!0;saveDayData(key,d);checkMilestones('brainstorm')}}function showExportOptions(){document.getElementById('exportModal').classList.add('active')}function closeExportModal(){document.getElementById('exportModal').classList.remove('active')}function exportAsText(){const notes=document.getElementById('brainstormNotes').value;if(!notes){alert('Nessuna nota da esportare');return}try{const blob=new Blob([notes],{type:'text/plain'}),url=URL.createObjectURL(blob),a=document.createElement('a');a.href=url;a.download=`mindstep_${currentDate.toISOString().split('T')[0]}.txt`;a.click();URL.revokeObjectURL(url);closeExportModal();showNotification('Note esportate!','üíæ')}catch(e){alert('Errore export')}}function sendToAI(ai){const notes=document.getElementById('brainstormNotes').value;if(!notes){alert('Nessuna nota da inviare');return}const date=currentDate.toLocaleDateString('it-IT'),prompt=`Data: ${date}%0A%0AI miei pensieri durante la camminata:%0A"${notes}"%0A%0AAiutami a:%0A1. Identificare i temi principali%0A2. Estrarre action items%0A3. Organizzare per priorit√†%0A4. Suggerire prossimi passi`;const urls={claude:'https://claude.ai/new?q='+prompt,chatgpt:'https://chat.openai.com/?q='+prompt,gemini:'https://gemini.google.com/?q='+prompt,copilot:'https://copilot.microsoft.com/?q='+prompt};window.open(urls[ai],'_blank');closeExportModal();showNotification(`Inviato a ${ai.charAt(0).toUpperCase()+ai.slice(1)}!`,'ü§ñ')}function openCustomMusic(){const url=document.getElementById('customMusic').value.trim();if(!url){alert('Inserisci un URL');return}window.open(url,'_blank')}function toggleSection(sec){const content=document.getElementById(sec+'Content'),expand=document.getElementById(sec+'Expand');content.classList.toggle('expanded');expand.classList.toggle('rotated')}function updateStreak(){document.getElementById('streakNum').textContent=calculateStreak()}function calculateStreak(){let s=0;const today=new Date();today.setHours(0,0,0,0);for(let i=0;i<365;i++){const d=new Date(today);d.setDate(today.getDate()-i);const k=d.toISOString().split('T')[0],data=getDayData(k);if((data.routines&&Object.values(data.routines).some(v=>v))||data.walk)s++;else break}return s}function updateWeeklyAnalytics(){const grid=document.getElementById('weekGrid');grid.innerHTML='';const days=['D','L','M','M','G','V','S'],start=new Date(currentDate);start.setDate(currentDate.getDate()-currentDate.getDay());let active=0,km=0,totalR=0,doneR=0;for(let i=0;i<7;i++){const d=new Date(start);d.setDate(start.getDate()+i);const k=d.toISOString().split('T')[0],data=getDayData(k);const hasAct=(data.routines&&Object.values(data.routines).some(v=>v))||data.walk;hasAct&&active++;data.walk&&(km+=data.walk.distance||0);if(data.routines){Object.values(data.routines).forEach((v,idx)=>{if(idx<routines.length){totalR++;v&&doneR++}})}const cell=document.createElement('div');cell.className='day-cell'+(hasAct?' active':'');cell.innerHTML=`<div class="day-name">${days[i]}</div><div style="font-size:18px">${hasAct?'‚úì':'‚àí'}</div>`;grid.appendChild(cell)}document.getElementById('activeDays').textContent=`${active}/7`;document.getElementById('totalKm').textContent=km.toFixed(1);document.getElementById('completedRoutines').textContent=(totalR>0?Math.round((doneR/totalR)*100):0)+'%'}function updateBadges(){const grid=document.getElementById('badgesGrid');grid.innerHTML='';const unlocked=JSON.parse(localStorage.getItem('mindstep_badges')||'[]');BADGES.forEach(b=>{const isU=unlocked.includes(b.id),badge=document.createElement('div');badge.className='badge'+(isU?' unlocked':'');badge.innerHTML=`<div class="badge-icon">${b.icon}</div><div class="badge-name">${b.name}</div>`;badge.onclick=()=>showBadgeModal(b,isU);grid.appendChild(badge)})}function showBadgeModal(b,unlocked){document.getElementById('badgeModalIcon').textContent=b.icon;document.getElementById('badgeModalTitle').textContent=b.name;document.getElementById('badgeModalDesc').textContent=(unlocked?'‚úÖ ':' üîí ')+b.desc;document.getElementById('badgeModal').classList.add('active')}function closeBadgeModal(){document.getElementById('badgeModal').classList.remove('active')}function checkMilestones(type){const unlocked=JSON.parse(localStorage.getItem('mindstep_badges')||'[]'),newBadges=[];BADGES.forEach(b=>{if(unlocked.includes(b.id))return;let unlock=!1;if(b.type===type||type==='check_all'){if(b.type==='walks'&&countTotalWalks()>=b.req)unlock=!0;if(b.type==='streak'&&calculateStreak()>=b.req)unlock=!0;if(b.type==='distance'&&getTotalDistance()>=b.req)unlock=!0;if(b.type==='special'&&type===b.id)unlock=!0;if(b.type==='walk_time'&&type===`time_${b.req}`)unlock=!0;if(b.type==='brainstorm'&&type==='brainstorm')unlock=!0}if(unlock){unlocked.push(b.id);newBadges.push(b)}});if(newBadges.length){localStorage.setItem('mindstep_badges',JSON.stringify(unlocked));updateBadges();newBadges.forEach(b=>showNotification(`Traguardo sbloccato: ${b.name}!`,b.icon))}}function countTotalWalks(){return Object.keys(localStorage).filter(k=>k.startsWith('mindstep_day_')&&JSON.parse(localStorage[k]).walk).length}function getTotalDistance(){let t=0;Object.keys(localStorage).forEach(k=>{if(k.startsWith('mindstep_day_')){const d=JSON.parse(localStorage[k]);d.walk?.distance&&(t+=d.walk.distance)}});return t}function showNotification(msg,icon){const notif=document.createElement('div');notif.className='notif-toast';notif.innerHTML=`<span class="notif-icon">${icon}</span><span class="notif-text">${msg}</span>`;document.body.appendChild(notif);setTimeout(()=>notif.remove(),3000);'Notification'in window&&Notification.permission==='granted'&&new Notification('MindStep',{body:msg,icon:'/icon-192.png'})}function setTheme(theme){document.documentElement.setAttribute('data-theme',theme);localStorage.setItem('mindstep_theme',theme);['Light','Auto','Dark'].forEach(t=>document.getElementById('theme'+t).classList.remove('active'));document.getElementById('theme'+theme.charAt(0).toUpperCase()+theme.slice(1)).classList.add('active')}function editProfile(){showScreen('screen-welcome');const u=JSON.parse(localStorage.getItem('mindstep_user'));document.getElementById('userName').value=u.name;document.getElementById('userAge').value=u.age||'';document.getElementById('userGender').value=u.gender||''}function editRoutines(){showScreen('screen-routines');const list=document.getElementById('routineList');list.innerHTML='';routines.forEach(r=>{addRoutineSetup();const inputs=list.querySelectorAll('input[type="text"]');inputs[inputs.length-1].value=r})}function exportAllData(){try{const all={user:JSON.parse(localStorage.getItem('mindstep_user')),routines,badges:JSON.parse(localStorage.getItem('mindstep_badges')||'[]'),version:APP_VERSION,exportDate:new Date().toISOString(),days:{}};Object.keys(localStorage).forEach(k=>{k.startsWith('mindstep_day_')&&(all.days[k.replace('mindstep_day_','')]=JSON.parse(localStorage[k]))});const blob=new Blob([JSON.stringify(all,null,2)],{type:'application/json'}),url=URL.createObjectURL(blob),a=document.createElement('a');a.href=url;a.download=`mindstep_export_${new Date().toISOString().split('T')[0]}.json`;a.click();URL.revokeObjectURL(url);showNotification('Dati esportati!','üíæ')}catch(e){alert('Errore export')}}function resetApp(){confirm('‚ö†Ô∏è Cancellare TUTTI i dati?')&&confirm('Ultima conferma? Non potrai recuperarli.')&&(localStorage.clear(),location.reload())}function getDayData(key){return JSON.parse(localStorage.getItem(`mindstep_day_${key}`)||'{}')}function saveDayData(key,data){localStorage.setItem(`mindstep_day_${key}`,JSON.stringify(data))}window.addEventListener('click',e=>{e.target===document.getElementById('exportModal')&&closeExportModal();e.target===document.getElementById('badgeModal')&&closeBadgeModal()});init();const savedTheme=localStorage.getItem('mindstep_theme')||'auto';setTheme(savedTheme);console.log('üå± MindStep v'+APP_VERSION);
